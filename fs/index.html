<!DOCTYPE html>
<html lang="en">

<head>
  <title>Miefalarm</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="chartist.min.css">
  <link rel="stylesheet" href="style.css">

  <style>
    @import 'https://fonts.googleapis.com/css?family=Montserrat:400,700|Oxygen:300,400';

    html {
      width: 100%;
      height: 100%;
    }

    body {
      background: #efefef;
      color: #333;
      font-family: "Oxygen";
      height: 100%;
    }

    /** tabs **/
    .tabs {
      padding: 20px;
    }

    .tabs input[name=tab-control] {
      display: none;
    }

    .tabs .content section h2,
    .tabs .nav ul li label {
      font-family: "Montserrat";
      font-weight: bold;
      font-size: 18px;
      color: #428BFF;
    }

    .tabs .nav ul {
      width: 100%;
      list-style-type: none;
      padding-left: 0;
      display: flex;
      flex-direction: row;
      margin-bottom: 10px;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .tabs .nav ul li {
      box-sizing: border-box;
      flex: 1;
      width: 50%;
      padding: 0 10px;
      text-align: center;
    }

    .tabs .nav ul li label {
      transition: all 0.3s ease-in-out;
      color: #929daf;
      padding: 5px auto;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      white-space: nowrap;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .tabs .nav ul li label br {
      display: none;
    }

    .tabs .nav ul li label svg {
      fill: #929daf;
      height: 1.2em;
      vertical-align: bottom;
      margin-right: 0.2em;
      transition: all 0.2s ease-in-out;
    }

    .tabs .nav ul li label:hover,
    .tabs .nav ul li label:focus,
    .tabs .nav ul li label:active {
      outline: 0;
      color: #bec5cf;
    }

    .tabs .nav ul li label:hover svg,
    .tabs .nav ul li label:focus svg,
    .tabs .nav ul li label:active svg {
      fill: #bec5cf;
    }

    .tabs .nav .slider {
      width: 50%;
      transition: all 0.33s cubic-bezier(0.38, 0.8, 0.32, 1.07);
    }

    .tabs .nav .slider .indicator {
      position: relative;
      width: 75%;
      max-width: 100%;
      margin: 0 auto;
      height: 4px;
      background: #428BFF;
      border-radius: 1px;
    }

    .tabs .content {
      margin-top: 60px;
    }

    .tabs .content section {
      display: none;
      -webkit-animation-name: content;
      animation-name: content;
      -webkit-animation-direction: normal;
      animation-direction: normal;
      -webkit-animation-duration: 0.3s;
      animation-duration: 0.3s;
      -webkit-animation-timing-function: ease-in-out;
      animation-timing-function: ease-in-out;
      -webkit-animation-iteration-count: 1;
      animation-iteration-count: 1;
      line-height: 1.4;
    }

    .tabs .content section h2 {
      color: #428BFF;
      display: none;
    }

    .tabs .content section h2::after {
      content: "";
      position: relative;
      display: block;
      width: 30px;
      height: 3px;
      background: #428BFF;
      margin-top: 5px;
      left: 1px;
    }

    .tabs input[name=tab-control]:nth-of-type(1):checked~.nav ul>li:nth-child(1)>label {
      cursor: default;
      color: #428BFF;
    }

    .tabs input[name=tab-control]:nth-of-type(1):checked~.nav ul>li:nth-child(1)>label svg {
      fill: #428BFF;
    }

    @media (max-width: 600px) {
      .tabs input[name=tab-control]:nth-of-type(1):checked~.nav ul>li:nth-child(1)>label {
        background: rgba(0, 0, 0, 0.08);
      }
    }

    .tabs input[name=tab-control]:nth-of-type(1):checked~.nav .slider {
      transform: translateX(0%);
    }

    .tabs input[name=tab-control]:nth-of-type(1):checked~.content>section:nth-child(1) {
      display: block;
    }

    .tabs input[name=tab-control]:nth-of-type(2):checked~.nav ul>li:nth-child(2)>label {
      cursor: default;
      color: #428BFF;
    }

    .tabs input[name=tab-control]:nth-of-type(2):checked~.nav ul>li:nth-child(2)>label svg {
      fill: #428BFF;
    }

    @media (max-width: 600px) {
      .tabs input[name=tab-control]:nth-of-type(2):checked~.nav ul>li:nth-child(2)>label {
        background: rgba(0, 0, 0, 0.08);
      }
    }

    .tabs input[name=tab-control]:nth-of-type(2):checked~.nav .slider {
      transform: translateX(100%);
    }

    .tabs input[name=tab-control]:nth-of-type(2):checked~.content>section:nth-child(2) {
      display: block;
    }

    @-webkit-keyframes content {
      from {
        opacity: 0;
        transform: translateY(5%);
      }

      to {
        opacity: 1;
        transform: translateY(0%);
      }
    }

    @keyframes content {
      from {
        opacity: 0;
        transform: translateY(5%);
      }

      to {
        opacity: 1;
        transform: translateY(0%);
      }
    }

    @media (max-width: 1000px) {
      .tabs .nav ul li label {
        white-space: initial;
      }

      .tabs .nav ul li label br {
        display: initial;
      }

      .tabs .nav ul li label svg {
        height: 1.5em;
      }
    }

    @media (max-width: 600px) {
      .tabs .nav ul li label {
        padding: 5px;
        border-radius: 5px;
      }

      .tabs .nav ul li label span {
        display: none;
      }

      .tabs .nav .slider {
        display: none;
      }

      .tabs .content {
        margin-top: 40px;
      }

      .tabs .content section h2 {
        display: none;
      }
    }

    /** material cards **/
    .card {
      font-size: .875rem;
      position: relative;
      display: flex;
      flex-direction: column;
      min-width: 0;
      word-wrap: break-word;
      border: 0;
      margin: 15px 0 15px 0;
      border-radius: 6px;
      color: #333;
      background: #fff;
      width: 100%;
      box-shadow: 0 1px 4px 0 rgb(0 0 0 / 14%);
    }

    .card-body {
      flex: 1 1 auto;
      padding: 1.25rem
    }

    .card-title {
      margin-bottom: .75rem
    }

    .card-subtitle {
      margin-top: -.375rem
    }

    .card-subtitle,
    .card-text:last-child {
      margin-bottom: 0
    }

    .card-header {
      padding: .75rem 1.25rem;
      margin-bottom: 0;
      background-color: #fff;
      border-bottom: 1px solid #eee
    }

    .card-header:first-child {
      border-radius: calc(.25rem - 1px) calc(.25rem - 1px) 0 0
    }

    .card-header+.list-group .list-group-item:first-child {
      border-top: 0
    }

    .card-footer {
      padding: .75rem 1.25rem;
      background-color: #fff;
      border-top: 1px solid #eee
    }

    .card-footer:last-child {
      border-radius: 0 0 calc(.25rem - 1px) calc(.25rem - 1px)
    }

    /* chartist threshold plugin */
    .ct-line.ct-threshold-above,
    .ct-point.ct-threshold-above,
    .ct-bar.ct-threshold-above {
      stroke: #f05b4f;
    }

    .ct-line.ct-threshold-below,
    .ct-point.ct-threshold-below,
    .ct-bar.ct-threshold-below {
      stroke: #59922b;
    }

    .ct-area.ct-threshold-above {
      fill: #f05b4f;
    }

    .ct-area.ct-threshold-below {
      fill: #59922b;
    }

    #calibrating {
      float: right;
      display: none;
    }
  </style>

  <script src="chartist.min.js"></script>
</head>

<body>
  <div class="tabs">
    <input type="radio" id="tab1" name="tab-control" checked>
    <input type="radio" id="tab2" name="tab-control">
    <div class="nav">
      <ul>
        <li title="Dashboard">
          <label for="tab1" role="button">
            <svg viewBox="0 0 24 24">
              <path d="M10,14 C10.5522847,14 11,14.4477153 11,15 L11,21 C11,21.5522847 10.5522847,22 10,22 L3,22 C2.44771525,22 2,21.5522847 2,21 L2,15 C2,14.4477153 2.44771525,14 3,14 L10,14 Z M21,9 C21.5522847,9 22,9.44771525 22,10 L22,21 C22,21.5522847 21.5522847,22 21,22 L14,22 C13.4477153,22 13,21.5522847 13,21 L13,10 C13,9.44771525 13.4477153,9 14,9 L21,9 Z M10,2 C10.5522847,2 11,2.44771525 11,3 L11,11 C11,11.5522847 10.5522847,12 10,12 L3,12 C2.44771525,12 2,11.5522847 2,11 L2,3 C2,2.44771525 2.44771525,2 3,2 L10,2 Z M21,2 C21.5522847,2 22,2.44771525 22,3 L22,6 C22,6.55228475 21.5522847,7 21,7 L14,7 C13.4477153,7 13,6.55228475 13,6 L13,3 C13,2.44771525 13.4477153,2 14,2 L21,2 Z"></path>
            </svg>
            <br />
            <span>Dashboard</span>
          </label>
        </li>
        <li title="Settings">
          <label for="tab2" role="button" onclick="onSettingsClicked()">
            <svg viewBox="0 0 24 24">
              <path d="M19.4,13c0-0.3,0.1-0.7,0.1-1s0-0.7-0.1-1l2.1-1.5c0.2-0.1,0.3-0.4,0.1-0.7l-2-3.5C19.5,5,19.2,4.9,19,5l-2.4,1.1  c-0.5-0.4-1.2-0.8-1.8-1l-0.3-2.6C14.5,2.2,14.3,2,14,2H10C9.7,2,9.5,2.2,9.5,2.5L9.2,5c-0.7,0.3-1.3,0.6-1.8,1L5,5  C4.8,4.9,4.5,5,4.4,5.2l-2,3.5C2.2,9,2.2,9.3,2.5,9.4L4.6,11c0,0.3-0.1,0.7-0.1,1s0,0.7,0.1,1l-2.1,1.5c-0.2,0.1-0.3,0.4-0.1,0.7  l2,3.5C4.5,19,4.8,19.1,5,19l2.4-1.1c0.5,0.4,1.2,0.8,1.8,1l0.3,2.6c0,0.3,0.2,0.5,0.5,0.5H14c0.3,0,0.5-0.2,0.5-0.5l0.3-2.6  c0.7-0.3,1.3-0.6,1.8-1L19,19c0.2,0.1,0.5,0,0.6-0.2l2-3.5c0.1-0.2,0.1-0.5-0.1-0.7L19.4,13z M12,16c-2.2,0-4-1.8-4-4  c0-2.2,1.8-4,4-4s4,1.8,4,4C16,14.2,14.2,16,12,16z"></path>
            </svg>
            <br />
            <span>Settings</span>
          </label>
        </li>
      </ul>
      <div class="slider">
        <div class="indicator"></div>
      </div>
    </div>
    <div class="content">
      <section>
        <h2>Dashboard</h2>
        <div class="row form">
          <div class="col c4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  CO2: <span id="currentCO2"></span> ppm
                  <span id="calibrating">...calibrating</span>
                </h3>
              </div>
              <div class="card-body">
                <div class="ct-chart ct-golden-section" id="co2"></div>
              </div>
            </div>
          </div>
          <div class="col c4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  Temperature: <span id="currentTemperature"></span> °C
                </h3>
              </div>
              <div class="card-body">
                <div class="ct-chart ct-golden-section" id="temperature"></div>
              </div>
            </div>
          </div>
          <div class="col c4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  Humidity: <span id="currentHumidity"></span> %
                </h3>
              </div>
              <div class="card-body">
                <div class="ct-chart ct-golden-section" id="humidity"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section>
        <h2>Settings</h2>
        <div class="row form">
          <div class="col c12">
            <div class="card">
              <div class="card-header">
                <div class="form-control" style="float:right">
                  <button id="btn_save_config" class="btn btn-sm btn-c" disabled>Save settings</button>
                </div>
              </div>
              <div class="card-body">
                <div class="row form">
                  <div class="col c4">
                    <div class="form-control">
                      <label for="wifi_ssid">WiFi Network:</label>
                      <select class="smooth" id="wifi_ssid" placeholder="Select WiFi network..."></select>
                    </div>
                    <div class="form-control">
                      <label for="wifi_pass">WiFi Password:</label>
                      <input type="text" class="smooth" id="wifi_pass" placeholder="Type WiFi password...">
                    </div>
                  </div>
                  <div class="col c4">
                    <!--
                    <div class="form-control">
                      <label for="sensor_config_url">Sensor Config URL:</label>
                      <input type="text" class="smooth" id="sensor_config_url" placeholder="Type Sensor Config URL...">
                    </div>
                    -->
                    <div class="form-control">
                      <label for="sensor_events_url">Events Push URL:</label>
                      <input type="text" class="smooth" id="sensor_events_url" placeholder="Type Sensor Events URL...">
                    </div>
                    <div class="form-control">
                      <label for="sensor_events_url">Push Interval:</label>
                      <input type="text" class="smooth" id="sensor_events_interval" placeholder="Type Sensor Push Interval...">&nbsp;seconds
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const input_wifi_ssid = document.getElementById("wifi_ssid")
    const input_wifi_pass = document.getElementById("wifi_pass")
    
    const input_sensor_events_url = document.getElementById("sensor_events_url")
    const input_sensor_events_interval = document.getElementById("sensor_events_interval")

    const btn_save_config = document.getElementById("btn_save_config")
    btn_save_config.onclick = saveConfig

    const textFields = {
      co2: document.getElementById("currentCO2"),
      temperature: document.getElementById("currentTemperature"),
      humidity: document.getElementById("currentHumidity"),
      calibrating: document.getElementById("calibrating")
    }

    const WIFI_AUTH_MODE = {
      0: "OPEN",
      1: "WEP",
      2: "WPA PSK",
      3: "WPA2 PSK",
      4: "WPA WPA2 PSK",
      5: "WPA2 ENTERPRISE",
    }

    var config

    async function wifiScan() {

      let resp = await fetch("/rpc/Wifi.Scan")
      if (resp.status !== 200) {
        console.error("wifi scan failed")
        return
      }
      let data = await resp.json();
      console.log(`wifi networks: ${JSON.stringify(data)}`)

      // populate select
      input_wifi_ssid.options.length = 0;
      for (ap of data) {
        //let text = `${ap.ssid} (${WIFI_AUTH_MODE[ap.auth]})`
        let text = ap.ssid || ap.bssid
        input_wifi_ssid.add(new Option(text, ap.ssid, false, ap.ssid === config.wifi.sta.ssid))
      };
      btn_save_config.disabled = false
    }

    async function loadConfig() {

      let resp = await fetch("/rpc/Config.Get")
      /*
      let resp = await fetch("/rpc/Config.Get", {
        method: "POST",
        body: JSON.stringify({
          key:"wifi"
        })
      })
      */
      if (resp.status !== 200) {
        console.error("load config failed")
        return
      }
      let data = await resp.json();
      console.log(`config loaded: ${JSON.stringify(data)}`)

      config = data
      input_wifi_pass.value = config.wifi.sta.pass
      input_sensor_events_url.value = config.cloud.sensor.events.url
      input_sensor_events_interval.value = config.cloud.sensor.events.interval
    }

    async function saveConfig() {

      let ssid = input_wifi_ssid.value
      let pass = input_wifi_pass.value
      let sensor_events_url = input_sensor_events_url.value
      let sensor_events_interval = input_sensor_events_interval.value
      //let sensor_config_url = input_sensor_config_url.value

      let resp = await fetch("/rpc/Config.Set", {
        method: "POST",
        body: JSON.stringify({
          config: {
            wifi: {
              sta: {
                enable: true,
                dhcp_hostname: "miefalarm",
                ssid: ssid,
                pass: pass
              }
            },
            cloud: {
              sensor: {
                events: {
                  url: sensor_events_url,
                  interval: sensor_events_interval
                }
              }
            }
          }
        }),
      })
      if (resp.status !== 200) {
        console.error("save config failed")
        return
      }

      /*
      resp = await fetch("/rpc/Config.Save", {
        method: "POST",
        body: JSON.stringify({
          "reboot": true
        })
      })
      if (resp.status !== 200) {
        console.error("save wifi config failed")
        return
      }
      */
    }

    async function onSettingsClicked() {
      await loadConfig()
      await wifiScan()
    }

    var chartData = {
      co2: {
        labels: [],
        series: [
          []
        ]
      },
      temperature: {
        labels: [],
        series: [
          []
        ]
      },
      humidity: {
        labels: [],
        series: [
          []
        ]
      }
    }
    var charts = {
      co2: null,
      temperature: null,
      humidity: null
    }

    function initDashboard() {

      let options = {
        showArea: true,
        showPoint: false,
        stretch: true,
        axisX: {
          showGrid: false
        },
        axisY: {
          type: Chartist.FixedScaleAxis,
          low: 0,
          high: 2500,
          divisor: 5,
        },
        lineSmooth: Chartist.Interpolation.cardinal({
          tension: 10
        }),
        chartPadding: {
          top: 0,
          right: 0,
          bottom: 0,
          left: 0
        },
        plugins: [
          Chartist.plugins.ctThreshold({
            threshold: 1000
          })
        ]
      }

      charts.co2 = new Chartist.Line('#co2', chartData.co2, options)

      options.axisY.high = 50
      options.plugins = [Chartist.plugins.ctThreshold({
        threshold: 25
      })]
      charts.temperature = new Chartist.Line('#temperature', chartData.temperature, options)

      options.axisY.high = 100
      options.plugins = [Chartist.plugins.ctThreshold({
        threshold: 50
      })]
      charts.humidity = new Chartist.Line('#humidity', chartData.humidity, options)

      setInterval(updateDashboard, 1000)
      updateDashboard()
    }

    var cycleCount = 0;
    async function updateDashboard() {
      resp = await fetch("/api/sensor/values")
      if (resp.status == 200) {
        let data = await resp.json()
        let label = new Date().toLocaleTimeString().substr(0, 5)
        for (d in data) {
          if (d === "calibrating") {
            textFields[d].style.display = data[d] ? "inline" : "none";
          } else {
            textFields[d].innerHTML = data[d]
            if (cycleCount % 10 === 0) {
              chartData[d].labels.push(label)
            } else {
              chartData[d].labels.push("")
            }
            chartData[d].labels.length > 100 && chartData[d].labels.shift()
            //let val = `${data[d]} ${d === "temperature" ? "°C" : "%"}`
            chartData[d].series[0].push(data[d])
            chartData[d].series[0].length > 100 && chartData[d].series[0].shift()
            charts[d].update(chartData[d])
          }
        }
        cycleCount++
      }
    }

    initDashboard()
  </script>

</body>

</html>